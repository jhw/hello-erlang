version: 0.2

# CodeBuild specification for building Erlang releases
# This builds the Erlang release in a large CodeBuild instance and uploads to S3

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "Installing Erlang/OTP and rebar3 using kerl..."
      - yum install -y wget tar gzip git ncurses-devel openssl-devel

      # Install kerl (curl is already available in CodeBuild)
      - curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
      - chmod +x kerl
      - mv kerl /usr/local/bin/

      # Configure kerl (minimal options for reliable build)
      - export KERL_CONFIGURE_OPTIONS="--disable-debug --without-javac --without-wx --without-odbc"
      - export KERL_BUILD_DOCS=no

      # Install Erlang/OTP (version from environment variable or default to 27.1)
      - export ERLANG_VERSION=${ERLANG_VERSION:-27.1}
      - echo "Installing Erlang/OTP ${ERLANG_VERSION} using kerl..."
      - kerl build ${ERLANG_VERSION} ${ERLANG_VERSION}
      - kerl install ${ERLANG_VERSION} /usr/local/erlang
      - source /usr/local/erlang/activate
      - export PATH=/usr/local/erlang/bin:$PATH

      # Install rebar3
      - wget https://s3.amazonaws.com/rebar3/rebar3
      - chmod +x rebar3
      - mv rebar3 /usr/local/bin/

  pre_build:
    commands:
      - echo "Build started on $(date)"
      - export PATH=/usr/local/erlang/bin:$PATH
      - erl -version
      - echo "Building in $(pwd)"
      - ls -la

  build:
    commands:
      - echo "Building Erlang release with ERTS (prod mode)..."
      - export PATH=/usr/local/erlang/bin:$PATH
      - rebar3 as prod tar
      - echo "Build completed"

  post_build:
    commands:
      - echo "Build completed on $(date)"
      - TARBALL=$(find _build/prod/rel -name "*.tar.gz" | head -1)
      - if [ -z "$TARBALL" ]; then echo "Error - tarball not found" && exit 1; fi
      - echo "Built tarball - $TARBALL"
      - TARBALL_NAME=$(basename "$TARBALL")
      - echo "Tarball name - $TARBALL_NAME"
      - echo "Preparing deployment bundle..."
      - mkdir -p bundle
      - echo "Extracting Erlang release..."
      - tar -xzf "$TARBALL" -C bundle/
      - echo "Adding CodeDeploy files..."
      - cp config/aws/appspec.yml bundle/appspec.yml
      - mkdir -p bundle/scripts
      - cp config/aws/codedeploy/*.sh bundle/scripts/
      - echo "Creating final deployment bundle..."
      - cd bundle && tar -czf ../hello_erlang.tar.gz . && cd ..
      - echo "Deployment bundle created"
      - ls -lh hello_erlang.tar.gz
      - echo "Deployment bundle contents:"
      - tar -tzf hello_erlang.tar.gz | head -20

artifacts:
  files:
    - 'hello_erlang.tar.gz'
  name: release-$(date +%Y%m%d-%H%M%S)
  discard-paths: yes

cache:
  paths:
    - '/root/.cache/rebar3/**/*'
