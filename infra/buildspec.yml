version: 0.2

# CodeBuild specification for building Erlang releases
# This builds the Erlang release in a large CodeBuild instance and uploads to S3

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "Activating pre-installed Erlang/OTP..."
      - source /usr/local/erlang/activate
      - export PATH=/usr/local/erlang/bin:$PATH
      - erl -version
      - rebar3 version

  pre_build:
    commands:
      - echo "Build started on $(date)"
      - export PATH=/usr/local/erlang/bin:$PATH
      - erl -version
      - echo "Building in $(pwd)"
      - ls -la

  build:
    commands:
      - echo "Building Erlang release with ERTS (prod mode)..."
      - export PATH=/usr/local/erlang/bin:$PATH
      - rebar3 as prod tar
      - echo "Build completed"

  post_build:
    commands:
      - echo "Build completed on $(date)"
      - TARBALL=$(find _build/prod/rel -name "*.tar.gz" | head -1)
      - if [ -z "$TARBALL" ]; then echo "Error - tarball not found" && exit 1; fi
      - echo "Built tarball - $TARBALL"
      - TARBALL_NAME=$(basename "$TARBALL")
      - echo "Tarball name - $TARBALL_NAME"
      - echo "Preparing deployment bundle..."
      - mkdir -p bundle
      - echo "Extracting Erlang release..."
      - tar -xzf "$TARBALL" -C bundle/
      - echo "Adding CodeDeploy files..."
      - cp infra/appspec.yml bundle/
      - mkdir -p bundle/scripts
      - cp infra/codedeploy/*.sh bundle/scripts/
      - echo "Deployment bundle structure:"
      - ls -la bundle/
      - echo "Scripts:"
      - ls -la bundle/scripts/

artifacts:
  files:
    - '**/*'
  base-directory: bundle

cache:
  paths:
    - '/root/.cache/rebar3/**/*'
